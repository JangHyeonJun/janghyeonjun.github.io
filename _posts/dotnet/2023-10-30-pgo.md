---
title: "PGO (Profile Guided Optimization, 프로필 기반 최적화)"
author: me
categories: [System]
tags: [system]
pin: true
math: true
mermaid: true
---

## PGO (Profile Guided Optimization, 프로필 기반 최적화)

프로파일링 옵션을 추가한 프로그램을 실행하면 프로필이라는 일종의 사용 통계 데이터가 남는다.
이 프로필 파일을 통해 다음 컴파일 시에 최적화를 해주는 기능.

네이티브 코드(C or C++)에서만 가능하고, 관리코드(C# 등)와 네이티브-관리 혼합(C++/CLI)에서는 불가능하다. 하지만 .NET6 부터 동일한 기능을 사용할 수 있도록 Dynamic PGO 라는 기능이 추가되었고,
기존의 PGO는 Static PGO 라고 칭하게 되었다. (Dynamic PGO는 다음 포스팅에 이어서 설명할 예정)

---

### PGO (=Static PGO) 프로세스

1. `/GL` 옵션을 컴파일 옵션에 추가하면 런타임 동작을 캡처할 수 있는 obj 파일들이 나온다.

2. GL옵션을 사용해서 뽑은 obj 파일들은 프로파일링을 옵션을 켜야만 링크가 가능하다. 링커 옵션에 `/LTCG`, `/GENPROFILE`와 같은 옵션을  추가하여 빌드 시 프로파일링을 위한 바이너리가 만들어진다.

3. 이 바이너리를 실행하면 일종의 통계 파일인 `.pgd` 파일이 생성됨.

4. 링커에 `USEPROFILE` 옵션과 함께 `.pgd` 파일을 설정하면 PGO가 적용된 최적화 빌드를 생성할 수 있다.

여기서 컴파일러와 링커를 혼용해서 사용하고 있는데 의문이 있을 수 있는데 후술하도록 하겠다.

---

### PGO 최적화 요소

`.pgd` 파일에는 다음과 같은 정보가 기록된다.

- 코드 블럭/함수 의 호출 횟수
- 조건문에서 분기별로 접근할 확률(e.g. `x <= 0 조건문으로 들어가 코드를 실행하는 경우가 85%` )
- 함수 호출 계층 그래프
- 변수와 명령줄 매개변수, 프로그램과 컴파일러 아키텍처 버전 등의 정보

`.pgd` 파일을 통해 다음과 같은 것들이 최적화된다.

- 인라인 처리: 자주 호출되는 함수가 있을경우 함수 콜을 하는 부분에 함수의 코드를 그대로 치환해준다.

- 가상 호출 추론: 가상 함수 호출시에 특정 클래스의 함수를 직접 캐스팅해서 호출하도록 코드를 수정한다. 캐스팅에 실패하면 기존 가상함수 호출 로직으로 다시 돌아간다.

- 레지스터 할당: 자주 사용되는 내용을 레지스터에 캐싱해둔다.

- 조건부 분기 최적화: 분기에서 자주 호출되는 코드블럭을 앞으로 배치해준다.

- 데드 코드 분리: 자주 사용되지 않는 코드는 다른 페이지에 모아둔다.

그 외 다른 최적화 기법들이 적용된다.

기타 자세한 내용은 [링크](https://learn.microsoft.com/ko-kr/cpp/build/profile-guided-optimizations?view=msvc-170)에서 확인 가능하다.

---

### PGO를 가능하게 만드는 기술

링커에게 프로필을 주어서 코드를 최적화하는건 LTCG(링크 타임 코드 생성)라는 기능이 있기 때문에 가능하다.

(LTCG 관련 자세한 내용은 공부하고 추가로 업데이트 할 예정...)

---

#### 참고하면 좋은 사이트

- https://learn.microsoft.com/ko-kr/cpp/build/reference/genprofile-fastgenprofile-generate-profiling-instrumented-build?view=msvc-170

- https://learn.microsoft.com/en-us/archive/msdn-magazine/2002/may/under-the-hood-link-time-code-generation

- https://learn.microsoft.com/ko-kr/cpp/build/reference/ltcg-link-time-code-generation?view=msvc-170

- https://devblogs.microsoft.com/cppblog/tag/profile-guided-optimization/